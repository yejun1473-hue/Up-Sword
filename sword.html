<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ê²€ ê°•í™” ê²Œì„ - í”Œë ˆì´</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background: #e6e9ed; font-family: 'Pretendard', sans-serif; margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        .game-container { width: 100%; max-width: 400px; background: white; border-radius: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); overflow: hidden; display: none; }
        
        #loading { padding: 50px; text-align: center; font-weight: bold; }
        #ban-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.95); color: white; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 10000; text-align: center; }
        #full-effect { position: fixed; top:0; left:0; width:100%; height:100%; z-index: 9999; display: none; align-items: center; justify-content: center; font-size: 40px; font-weight: 900; color: white; pointer-events: none; text-align: center; white-space: pre-line; }

        .header { background: #2c3e50; color: white; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; }
        .left-group { display: flex; align-items: center; gap: 12px; }
        
        .home-btn { background: rgba(255,255,255,0.2); border: none; color: white; width: 35px; height: 35px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .home-btn:hover { background: rgba(255,255,255,0.3); }

        .gold-wrap { display: flex; align-items: center; gap: 8px; position: relative; }
        .code-btn { background: #f1c40f; border: none; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: bold; cursor: pointer; }

        .money-float { position: absolute; right: 40px; top: -10px; font-weight: 900; font-size: 22px; animation: floatUp 3s forwards; pointer-events: none; z-index: 100; }
        @keyframes floatUp { 0% { opacity: 0; transform: translateY(0); } 10% { opacity: 1; } 100% { opacity: 0; transform: translateY(-80px); } }

        .img-area { background: #f0f0f0; height: 210px; margin: 15px; border-radius: 20px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .sword-img { max-width: 75%; max-height: 75%; object-fit: contain; }
        .hammering { animation: hammer 0.1s infinite; }
        @keyframes hammer { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }

        .btn-group { padding: 15px; display: flex; gap: 8px; }
        .btn-main { flex: 2; padding: 16px; border-radius: 12px; border: none; font-weight: bold; font-size: 16px; cursor: pointer; background: #2c3e50; color: white; }
        .btn-sub { flex: 1; padding: 16px; border-radius: 12px; border: none; font-weight: bold; background: #f1f2f6; cursor: pointer; }
    </style>
</head>
<body>

<div id="loading">ë¡œë”© ì¤‘...</div>

<div id="ban-overlay"><h1>ğŸš«</h1><h2>ì„ì‹œ ì •ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.</h2><p>ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.</p></div>
<div id="full-effect"></div>

<div class="game-container" id="game-ui">
    <div class="header">
        <div class="left-group">
            <button class="home-btn" onclick="location.href='index.html'" title="í™ˆìœ¼ë¡œ">
                <i class="fa-solid fa-house"></i>
            </button>
            <span id="u-nick" style="font-size: 14px;">...ë‹˜</span>
        </div>
        <div class="gold-wrap" id="gold-anchor">
            <span id="u-gold" style="color: #f1c40f; font-weight: bold;">0G</span>
            <button class="code-btn" onclick="redeem()">ì½”ë“œ</button>
        </div>
    </div>

    <div style="padding: 12px 15px; font-size: 13px;"><b>ë£¨ëŒí”„:</b> <span id="npc-text">ë°˜ê°‘ë„¤! ê°•í™”í•˜ëŸ¬ ì™”ë‚˜?</span></div>
    
    <div class="img-area"><img id="s-img" src="" class="sword-img" alt="sword"></div>
    
    <div style="padding: 0 20px 10px;">
        <div id="s-name" style="font-size: 19px; font-weight: bold;">...</div>
        <div id="s-desc" style="font-size: 12px; color: #7f8c8d; margin-top: 4px;">...</div>
        <div id="s-info" style="font-size: 13px; color: #2c3e50; margin-top: 8px; font-weight: bold;">ê°•í™”: 0G | íŒë§¤: 0G | í™•ë¥ : 0%</div>
    </div>

    <div class="btn-group">
        <button class="btn-sub" onclick="handleSell()">íŒë§¤</button>
        <button class="btn-main" onclick="handleUpgrade()">ê°•í™”í•˜ê¸°</button>
    </div>
</div>

<script>
    // --- ì„¤ì •ë¶€ ---
    const SUPABASE_URL = 'https://utfrjzcnefsbuadnkdud.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV0ZnJqemNuZWZzYnVhZG5rZHVkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4MjE1MTYsImV4cCI6MjA4MjM5NzUxNn0.D3Za1nMw-x0JwOpkFuYceUHlagcpRdrpFqNUIP5Kjdc';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    let user = null;
    let swords = {}; // ì „ì—­ ê²€ ë°ì´í„° ê°ì²´

    // ê¸°ë³¸ ê²€ ë°ì´í„° (DB ë¡œë“œ ì‹¤íŒ¨ ì‹œ ë³´ê°•ìš©)
    const fallbackSwords = {
        1: { level: 1, name: "ë‚¡ì€ ê²€", description: "ê¸°ë³¸ ê²€ì…ë‹ˆë‹¤.", upgrade_cost: 100, sell_price: 0, success_rate: 0.8, image_url: "https://via.placeholder.com/200?text=Sword+1" }
    };

    // --- ì´ˆê¸°í™” ---
    async function init() {
        try {
            const { data: { session }, error: sessionErr } = await supabaseClient.auth.getSession();
            if (!session || sessionErr) { location.href = "login.html"; return; }

            // 1. í”„ë¡œí•„ ë¡œë“œ
            const { data: p, error: pErr } = await supabaseClient.from('profiles').select('*').eq('id', session.user.id).single();
            if (pErr) throw pErr;
            if (p.is_banned) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('ban-overlay').style.display = 'flex';
                return;
            }
            user = p;

            // [ì—ëŸ¬ í•´ê²° í•µì‹¬] ìœ ì € ë ˆë²¨ì´ 0ì´ê±°ë‚˜ ì—†ì„ ê²½ìš° ê°•ì œ 1ë ˆë²¨ ë³´ì •
            if (!user.current_sword_lvl || user.current_sword_lvl < 1) {
                user.current_sword_lvl = 1;
                await supabaseClient.from('profiles').update({ current_sword_lvl: 1 }).eq('id', user.id);
            }

            // 2. ê²€ ë°ì´í„° ë¡œë“œ
            const { data: sData, error: sErr } = await supabaseClient.from('sword_data').select('*').order('level', { ascending: true });
            if (sErr) throw sErr;

            if (sData && sData.length > 0) {
                sData.forEach(item => { swords[item.level] = item; });
            } else {
                swords = { ...fallbackSwords };
            }

            document.getElementById('loading').style.display = 'none';
            document.getElementById('game-ui').style.display = 'block';
            updateUI();

        } catch (e) {
            console.error(e);
            alert("ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    }

    // --- UI ì—…ë°ì´íŠ¸ ---
    function updateUI() {
        if (!user) return;

        // í˜„ì¬ ë ˆë²¨ì— í•´ë‹¹í•˜ëŠ” ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë ˆë²¨ 1 ë°ì´í„° ì‚¬ìš©
        const currentLvl = user.current_sword_lvl || 1;
        let item = swords[currentLvl];

        if (!item) {
            console.warn(`Level ${currentLvl} data not found. Falling back to Level 1.`);
            item = swords[1] || fallbackSwords[1];
            user.current_sword_lvl = 1; // ë°ì´í„° ë§¤ì¹­ ì•ˆë  ì‹œ ë ˆë²¨ ì´ˆê¸°í™”
        }

        document.getElementById('u-nick').innerText = (user.nickname || "ì—¬í–‰ì") + "ë‹˜";
        document.getElementById('u-gold').innerText = user.gold.toLocaleString() + "G";
        document.getElementById('s-name').innerText = `[+${item.level}] ${item.name}`;
        document.getElementById('s-desc').innerText = item.description || "";
        document.getElementById('s-info').innerText = `ê°•í™”: ${item.upgrade_cost.toLocaleString()}G | íŒë§¤: ${(item.sell_price || 0).toLocaleString()}G | í™•ë¥ : ${Math.round(item.success_rate * 100)}%`;
        document.getElementById('s-img').src = item.image_url;
    }

    // --- ê°•í™” ë¡œì§ ---
    async function handleUpgrade() {
        const currentItem = swords[user.current_sword_lvl];
        if (!currentItem) return alert("ê²€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        if (user.gold < currentItem.upgrade_cost) return alert("ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!");

        const img = document.getElementById('s-img');
        img.classList.add('hammering');
        showGoldEffect(currentItem.upgrade_cost, false);

        // ê²°ê³¼ ê³„ì‚°
        const isSuccess = Math.random() < currentItem.success_rate;
        let nextLvl;

        if (isSuccess) {
            nextLvl = user.current_sword_lvl + 1;
            // ë‹¤ìŒ ë ˆë²¨ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë§Œë ™ ì²˜ë¦¬
            if (!swords[nextLvl]) {
                img.classList.remove('hammering');
                return alert("ì´ë¯¸ ìµœê³  ë‹¨ê³„ì˜ ê²€ì…ë‹ˆë‹¤!");
            }
        } else {
            // ì‹¤íŒ¨ ì‹œ 1 ë¯¸ë§Œ(0ë ˆë²¨)ìœ¼ë¡œ ë–¨ì–´ì§€ì§€ ì•Šê²Œ Math.max ì‚¬ìš©
            nextLvl = Math.max(1, user.current_sword_lvl - 1);
        }

        user.gold -= currentItem.upgrade_cost;

        // DB ë°˜ì˜
        const { error } = await supabaseClient
            .from('profiles')
            .update({ gold: user.gold, current_sword_lvl: nextLvl })
            .eq('id', user.id);

        if (error) {
            alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            img.classList.remove('hammering');
            return;
        }

        setTimeout(() => {
            img.classList.remove('hammering');
            user.current_sword_lvl = nextLvl;
            showEffect(isSuccess);
            updateUI();
        }, 600);
    }

    // --- íŒë§¤ ë¡œì§ ---
    async function handleSell() {
        if (user.current_sword_lvl === 1) return alert("ê¸°ë³¸ ê²€ì€ íŒë§¤í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        
        const item = swords[user.current_sword_lvl];
        const price = item.sell_price || 0;

        if (!confirm(`${item.name}ì„(ë¥¼) ${price.toLocaleString()}Gì— íŒë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

        user.gold += price;
        user.current_sword_lvl = 1;

        const { error } = await supabaseClient
            .from('profiles')
            .update({ gold: user.gold, current_sword_lvl: 1 })
            .eq('id', user.id);

        if (error) return alert("íŒë§¤ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");

        showGoldEffect(price, true);
        alert(`íŒë§¤ ì™„ë£Œ! ${price.toLocaleString()}Gë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤.`);
        updateUI();
    }

    // --- íš¨ê³¼ ì—°ì¶œ ---
    function showEffect(success) {
        const el = document.getElementById('full-effect');
        el.style.display = 'flex';
        el.style.backgroundColor = success ? 'rgba(52, 152, 219, 0.8)' : 'rgba(231, 76, 60, 0.8)';
        el.innerText = success ? "ê°•í™” ì„±ê³µ!!" : "ê°•í™” ì‹¤íŒ¨!\në ˆë²¨ì´ í•˜ë½í•©ë‹ˆë‹¤.";
        setTimeout(() => { el.style.display = 'none'; }, 800);
    }

    function showGoldEffect(amt, isPlus) {
        const el = document.createElement('div');
        el.className = 'money-float';
        el.style.color = isPlus ? '#3498db' : '#e74c3c';
        el.innerText = (isPlus ? '+' : '-') + Math.abs(amt).toLocaleString() + 'G';
        document.getElementById('gold-anchor').appendChild(el);
        setTimeout(() => el.remove(), 2500);
    }

    // --- ì¿ í° ì½”ë“œ ---
    async function redeem() {
        const code = prompt("ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
        if (!code) return;

        const { data, error } = await supabaseClient.from('reward_codes').select('*').eq('code', code).single();
        if (error || !data) return alert("ìœ íš¨í•˜ì§€ ì•Šì€ ì½”ë“œì…ë‹ˆë‹¤.");

        user.gold += data.reward_gold;
        await supabaseClient.from('profiles').update({ gold: user.gold }).eq('id', user.id);
        
        showGoldEffect(data.reward_gold, true);
        alert(`${data.reward_gold.toLocaleString()}Gë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤!`);
        updateUI();
    }

    init();
</script>
</body>
</html>
