const SUPABASE_URL = 'https://utfrjzcnefsbuadnkdud.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV0ZnJqemNuZWZzYnVhZG5rZHVkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4MjE1MTYsImV4cCI6MjA4MjM5NzUxNn0.D3Za1nMw-x0JwOpkFuYceUHlagcpRdrpFqNUIP5Kjdc';
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
let user = null;

// 강화 데이터 저장소
let swords = {};

// 기본 검 데이터 (DB 로드 실패 시 또는 1레벨 기본값)
const defaultSwords = {
    1: {
        level: 1,
        name: "낡은 검",
        description: "기본 검입니다.",
        upgrade_cost: 100,
        sell_price: 0,
        success_rate: 0.8,
        image_url: "https://via.placeholder.com/200x100?text=낡은+검"
    }
};

async function init() {
    try {
        console.log('Initializing game...');
        const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
        
        if (!session) { 
            location.href = "login.html"; 
            return; 
        }

        // 1. 유저 프로필 로드
        const { data: p, error: profileError } = await supabaseClient
            .from('profiles')
            .select('*')
            .eq('id', session.user.id)
            .single();
            
        if (profileError) throw profileError;
        if (p.is_banned) { 
            document.getElementById('loading').style.display = 'none'; 
            document.getElementById('ban-overlay').style.display = 'flex'; 
            return; 
        }

        user = p;

        // [중요] DB에서 가져온 레벨이 0이거나 비어있으면 1로 강제 고정
        if (!user.current_sword_lvl || user.current_sword_lvl < 1) {
            user.current_sword_lvl = 1;
        }

        // 2. 검 데이터 로드
        const { data: s, error: swordError } = await supabaseClient
            .from('sword_data')
            .select('*')
            .order('level', { ascending: true });
            
        if (swordError) throw swordError;
        
        if (s && s.length > 0) {
            s.forEach(i => { swords[i.level] = i; });
        } else {
            Object.assign(swords, defaultSwords);
        }
        
        document.getElementById('loading').style.display = 'none';
        document.getElementById('game-ui').style.display = 'block';
        updateUI();
    } catch (error) {
        console.error('초기화 오류:', error);
        alert('데이터를 불러오지 못했습니다. 새로고침 해주세요.');
    }
}

function updateUI() {
    // 유저가 가진 레벨의 검 데이터가 없는 경우 방어 로직
    if (!swords[user.current_sword_lvl]) {
        console.warn(`Level ${user.current_sword_lvl} data missing, fallback to level 1`);
        user.current_sword_lvl = 1;
    }

    const item = swords[user.current_sword_lvl] || defaultSwords[1];
    
    document.getElementById('u-nick').innerText = user.nickname + "님";
    document.getElementById('u-gold').innerText = user.gold.toLocaleString() + "G";
    document.getElementById('s-name').innerText = `[+${item.level}] ${item.name}`;
    document.getElementById('s-desc').innerText = item.description || "설명 없음";
    document.getElementById('s-info').innerText = `강화: ${item.upgrade_cost.toLocaleString()}G | 판매: ${(item.sell_price || 0).toLocaleString()}G | 확률: ${Math.floor(item.success_rate * 100)}%`;
    document.getElementById('s-img').src = item.image_url;
}

async function handleUpgrade() {
    const s = swords[user.current_sword_lvl];
    if (!s) return alert("검 정보를 찾을 수 없습니다.");
    if (user.gold < s.upgrade_cost) return alert("골드가 부족합니다!");

    const img = document.getElementById('s-img');
    img.classList.add('hammering');
    showGoldEffect(s.upgrade_cost, false);
    
    const success = Math.random() < s.success_rate;
    let nextLvl;
    
    if (success) {
        nextLvl = user.current_sword_lvl + 1;
        if (!swords[nextLvl]) { 
            img.classList.remove('hammering'); 
            return alert("이미 최고 레벨입니다!"); 
        }
    } else {
        // [수정] 실패 시 1레벨보다 낮아지지 않도록 확실하게 처리
        nextLvl = user.current_sword_lvl > 1 ? user.current_sword_lvl - 1 : 1;
    }

    user.gold -= s.upgrade_cost;
    
    // DB 업데이트
    const { error } = await supabaseClient
        .from('profiles')
        .update({ gold: user.gold, current_sword_lvl: nextLvl })
        .eq('id', user.id);

    if (error) {
        alert("저장 중 오류가 발생했습니다.");
        return;
    }

    setTimeout(() => {
        img.classList.remove('hammering');
        user.current_sword_lvl = nextLvl;
        showEffect(success);
        updateUI();
    }, 600);
}

function showEffect(success) {
    const el = document.getElementById('full-effect');
    el.style.display = 'flex';
    el.style.backgroundColor = success ? 'rgba(52, 152, 219, 0.8)' : 'rgba(231, 76, 60, 0.8)';
    el.innerText = success ? "강화 성공!!" : "강화 실패!\n-1LV";
    setTimeout(() => { el.style.display = 'none'; }, 800); 
}

async function handleSell() {
    const item = swords[user.current_sword_lvl];
    if (user.current_sword_lvl === 1) return alert("기본 검은 판매할 수 없습니다!");
    
    const price = item.sell_price || 0;
    if (!confirm(`${item.name}을 ${price.toLocaleString()}G에 판매하시겠습니까?`)) return;
    
    user.gold += price;
    user.current_sword_lvl = 1; // 판매 후 1레벨로 초기화
    
    await supabaseClient.from('profiles').update({ gold: user.gold, current_sword_lvl: 1 }).eq('id', user.id);
    showGoldEffect(price, true);
    alert(`판매 완료! +${price.toLocaleString()}G`);
    updateUI();
}

function showGoldEffect(amt, isPlus) {
    const el = document.createElement('div');
    el.className = 'money-float';
    el.style.color = isPlus ? '#3498db' : '#e74c3c';
    el.innerText = (isPlus ? '+' : '-') + Math.abs(amt).toLocaleString() + 'G';
    document.getElementById('gold-anchor').appendChild(el);
    setTimeout(() => el.remove(), 3000);
}

async function redeem() {
    const code = prompt("코드를 입력하세요");
    if (!code) return;
    const { data } = await supabaseClient.from('reward_codes').select('*').eq('code', code).single();
    if (!data) return alert("유효하지 않은 코드입니다.");
    
    user.gold += data.reward_gold;
    await supabaseClient.from('profiles').update({ gold: user.gold }).eq('id', user.id);
    showGoldEffect(data.reward_gold, true);
    updateUI();
}

init();
