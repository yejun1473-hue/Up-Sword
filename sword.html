<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ê²€ ê°•í™” ê²Œì„ - í”Œë ˆì´</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background: #e6e9ed; font-family: 'Pretendard', sans-serif; margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        .game-container { width: 100%; max-width: 400px; background: white; border-radius: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); overflow: hidden; display: none; }
        
        #ban-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.95); color: white; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 10000; text-align: center; }
        #full-effect { position: fixed; top:0; left:0; width:100%; height:100%; z-index: 9999; display: none; align-items: center; justify-content: center; font-size: 40px; font-weight: 900; color: white; pointer-events: none; text-align: center; }

        .header { background: #2c3e50; color: white; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; }
        .left-group { display: flex; align-items: center; gap: 12px; }
        
        /* í™ˆ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .home-btn { background: rgba(255,255,255,0.2); border: none; color: white; width: 35px; height: 35px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .home-btn:hover { background: rgba(255,255,255,0.3); }

        .gold-wrap { display: flex; align-items: center; gap: 8px; position: relative; }
        .code-btn { background: #f1c40f; border: none; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: bold; cursor: pointer; }

        .money-float { position: absolute; right: 40px; top: -10px; font-weight: 900; font-size: 22px; animation: floatUp 3s forwards; pointer-events: none; z-index: 100; }
        @keyframes floatUp { 0% { opacity: 0; transform: translateY(0); } 10% { opacity: 1; } 100% { opacity: 0; transform: translateY(-80px); } }

        .img-area { background: #f0f0f0; height: 210px; margin: 15px; border-radius: 20px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .sword-img { max-width: 75%; max-height: 75%; object-fit: contain; }
        .hammering { animation: hammer 0.1s infinite; }
        @keyframes hammer { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }

        .btn-group { padding: 15px; display: flex; gap: 8px; }
        .btn-main { flex: 2; padding: 16px; border-radius: 12px; border: none; font-weight: bold; font-size: 16px; cursor: pointer; background: #2c3e50; color: white; }
        .btn-sub { flex: 1; padding: 16px; border-radius: 12px; border: none; font-weight: bold; background: #f1f2f6; cursor: pointer; }
    </style>
</head>
<body>
<div id="loading">ë¡œë”© ì¤‘...</div>

<div id="ban-overlay"><h1>ğŸš«</h1><h2>ì„ì‹œ ì •ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.</h2><p>ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.</p></div>
<div id="full-effect"></div>

<div class="game-container" id="game-ui">
    <div class="header">
        <div class="left-group">
            <button class="home-btn" onclick="location.href='index.html'" title="í™ˆìœ¼ë¡œ">
                <i class="fa-solid fa-house"></i>
            </button>
            <span id="u-nick" style="font-size: 14px;">...ë‹˜</span>
        </div>
        <div class="gold-wrap" id="gold-anchor">
            <span id="u-gold" style="color: #f1c40f; font-weight: bold;">0G</span>
            <button class="code-btn" onclick="redeem()">ì½”ë“œ</button>
        </div>
    </div>

    <div style="padding: 12px 15px; font-size: 13px;"><b>ë£¨ëŒí”„:</b> <span id="npc-text">ë°˜ê°‘ë„¤! ê°•í™”í•˜ëŸ¬ ì™”ë‚˜?</span></div>
    
    <div class="img-area"><img id="s-img" src="" class="sword-img"></div>
    
    <div style="padding: 0 20px 10px;">
        <div id="s-name" style="font-size: 19px; font-weight: bold;">...</div>
        <div id="s-desc" style="font-size: 12px; color: #7f8c8d; margin-top: 4px;">...</div>
        <div id="s-info" style="font-size: 13px; color: #2c3e50; margin-top: 8px; font-weight: bold;">ê°•í™”: 0G | íŒë§¤: 0G | í™•ë¥ : 0%</div>
    </div>

    <div class="btn-group">
        <button class="btn-sub" onclick="handleSell()">íŒë§¤</button>
        <button class="btn-main" onclick="handleUpgrade()">ê°•í™”í•˜ê¸°</button>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://utfrjzcnefsbuadnkdud.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV0ZnJqemNuZWZzYnVhZG5rZHVkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4MjE1MTYsImV4cCI6MjA4MjM5NzUxNn0.D3Za1nMw-x0JwOpkFuYceUHlagcpRdrpFqNUIP5Kjdc';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    let user = null, swords = {};

    // ê¸°ë³¸ ê²€ ì •ë³´ (ë°ì´í„°ë² ì´ìŠ¤ ë¡œë“œ ì‹¤íŒ¨ ì‹œ ì‚¬ìš©)
    const defaultSwords = {
        1: {
            level: 1,
            name: "ë‚¡ì€ ê²€",
            description: "ê¸°ë³¸ ê²€ì…ë‹ˆë‹¤.",
            upgrade_cost: 100,
            sell_price: 0,
            success_rate: 0.8,
            image_url: "https://via.placeholder.com/200x100?text=ë‚¡ì€+ê²€"
        },
        2: {
            level: 2,
            name: "ê°•ì²  ê²€",
            description: "íŠ¼íŠ¼í•œ ê°•ì²  ê²€ì…ë‹ˆë‹¤.",
            upgrade_cost: 300,
            sell_price: 50,
            success_rate: 0.7,
            image_url: "https://via.placeholder.com/200x100?text=ê°•ì² +ê²€"
        }
        // í•„ìš”ì— ë”°ë¼ ë” ë§ì€ ë ˆë²¨ ì¶”ê°€ ê°€ëŠ¥
    };

    async function init() {
        try {
            const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
            if(sessionError) throw sessionError;
            if(!session) { 
                location.href = "login.html"; 
                return; 
            }

            const { data: p, error: profileError } = await supabaseClient
                .from('profiles')
                .select('*')
                .eq('id', session.user.id)
                .single();
                
            if(profileError) throw profileError;
            if(p.is_banned) { 
                document.getElementById('loading').style.display = 'none'; 
                document.getElementById('ban-overlay').style.display = 'flex'; 
                return; 
            }
            
            user = p;
            
            // ê²€ ì •ë³´ ë¡œë“œ ì‹œë„
            const { data: s, error: swordError } = await supabaseClient
                .from('sword_data')
                .select('*')
                .order('level', { ascending: true });
                
            if(swordError) throw swordError;
            
            if(s && s.length > 0) {
                s.forEach(i => swords[i.level] = i);
            } else {
                // ë°ì´í„°ë² ì´ìŠ¤ì— ë°ì´í„°ê°€ ì—†ì„ ê²½ìš° ê¸°ë³¸ ë°ì´í„° ì‚¬ìš©
                Object.assign(swords, defaultSwords);
                console.warn('ê²€ ì •ë³´ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ê¸°ë³¸ ë°ì´í„°ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.');
            }
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('game-ui').style.display = 'block';
            updateUI();
        } catch (error) {
            console.error('ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
            alert('ê²Œì„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.');
            // ì˜¤ë¥˜ ë°œìƒ ì‹œ ê¸°ë³¸ ë°ì´í„° ì‚¬ìš©
            Object.assign(swords, defaultSwords);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('game-ui').style.display = 'block';
            updateUI();
        }
    }

    function updateUI() {
        const item = swords[user.current_sword_lvl] || swords[1];
        document.getElementById('u-nick').innerText = user.nickname + "ë‹˜";
        document.getElementById('u-gold').innerText = user.gold.toLocaleString() + "G";
        
        // ë ˆë²¨ í‘œì‹œ: +1ê°•ë¶€í„° í‘œì‹œë˜ë„ë¡ ì„¤ì • ìœ ì§€
        document.getElementById('s-name').innerText = `[+${item.level}] ${item.name}`;
        
        document.getElementById('s-desc').innerText = item.description || "ì„¤ëª… ì—†ìŒ";
        document.getElementById('s-info').innerText = `ê°•í™”: ${item.upgrade_cost.toLocaleString()}G | íŒë§¤: ${(item.sell_price || 0).toLocaleString()}G | í™•ë¥ : ${item.success_rate*100}%`;
        document.getElementById('s-img').src = item.image_url;
    }

    function showGoldEffect(amt, isPlus) {
        const el = document.createElement('div');
        el.className = 'money-float';
        el.style.color = isPlus ? '#3498db' : '#e74c3c';
        el.innerText = (isPlus ? '+' : '-') + Math.abs(amt).toLocaleString() + 'G';
        document.getElementById('gold-anchor').appendChild(el);
        setTimeout(() => el.remove(), 3000);
    }

    async function handleUpgrade() {
        const s = swords[user.current_sword_lvl];
        if (!s) {
            console.error('No sword data found for level:', user.current_sword_lvl);
            return alert('ê°•í™” ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
        
        if(user.gold < s.upgrade_cost) return alert("ê³¨ë“œ ë¶€ì¡±!");
        const img = document.getElementById('s-img');
        img.classList.add('hammering');
        showGoldEffect(s.upgrade_cost, false);
        
        const success = Math.random() < s.success_rate;
        let nextLvl;
        
        if (success) {
            nextLvl = user.current_sword_lvl + 1;
            if (!swords[nextLvl]) { 
                img.classList.remove('hammering'); 
                return alert("ìµœê³  ë ˆë²¨!"); 
            }
        } else {
            // ì‹¤íŒ¨ ì‹œ -1LV í•˜ë½ ìœ ì§€
            nextLvl = Math.max(1, user.current_sword_lvl - 1);
        }

        user.gold -= s.upgrade_cost;
        await supabaseClient.from('profiles').update({ gold: user.gold, current_sword_lvl: nextLvl }).eq('id', user.id);
        
        setTimeout(() => {
            img.classList.remove('hammering');
            user.current_sword_lvl = nextLvl;
            showEffect(success);
            updateUI();
        }, 600);
    }

    function showEffect(success) {
        const el = document.getElementById('full-effect');
        el.style.display = 'flex';
        el.style.backgroundColor = success ? 'rgba(52, 152, 219, 0.8)' : 'rgba(231, 76, 60, 0.8)';
        el.innerText = success ? "ê°•í™” ì„±ê³µ!!" : "ê°•í™” ì‹¤íŒ¨!\n-1LV";
        setTimeout(() => { el.style.display = 'none'; }, 800); 
    }

    async function handleSell() {
        const item = swords[user.current_sword_lvl];
        if(user.current_sword_lvl === 1) return alert("ê¸°ë³¸ ê²€ì€ íŒë§¤ ë¶ˆê°€!");
        const price = item.sell_price || 0;
        if(!confirm(`${item.name}ì„ ${price.toLocaleString()}Gì— íŒŒì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
        user.gold += price;
        user.current_sword_lvl = 1;
        await supabaseClient.from('profiles').update({ gold: user.gold, current_sword_lvl: 1 }).eq('id', user.id);
        showGoldEffect(price, true);
        alert(`íŒë§¤ ì™„ë£Œ! +${price.toLocaleString()}G`);
        updateUI();
    }

    async function redeem() {
        const code = prompt("ì½”ë“œ ì…ë ¥");
        const { data } = await supabaseClient.from('reward_codes').select('*').eq('code', code).single();
        if(!data) return alert("ì½”ë“œ ì˜¤ë¥˜");
        user.gold += data.reward_gold;
        await supabaseClient.from('profiles').update({ gold: user.gold }).eq('id', user.id);
        showGoldEffect(data.reward_gold, true);
        updateUI();
    }

    init();
</script>
</body>
</html>
